#<a name="top"></a>Cosmos Auth

* [What is cosmos-auth](#whatis)
* [Installation](#maininstall)
    * [Prerequisites](#prerequisites)
    * [Installation](#installation)
    * [Unit tests](#unittests)
* [Configuration](#configuration)
* [Running](#running)
* [Usage](#usage)
* [Contact](#contact)

##<a name="whatis"></a>What is cosmos-auth
cosmos-auth exposes a RESTful API for [OAuth2](http://oauth.net/2/) tokens generation. These tokens are used in other Cosmos RESTful APIs, such as [WebHDFS](http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/WebHDFS.html) for authentication/authorization purposes.

In fact, tokens are not really generated by cosmos-auth, but by an Identity Manager (FIWARE's implementation is [Keyrock](http://catalogue.fiware.org/enablers/identity-management-keyrock)) which is accessed by this API. So why not directy accessing the Identity Manager? This is because some sensible information regarding the Cosmos application is needed when requesting a token to the Identity Manager; specifically the `client_id` and `client_secret` generated once the Cosmos application is registered. Thus, in order this information continues being secret, it is necessary this kind of intermediary service.

[Transport Layer Security](https://en.wikipedia.org/wiki/Transport_Layer_Security) (TLS) is used to provide communications security through asymetric cryptography (public/private encryption keys).

[Top](#top)

##<a name="maininstall"></a>Installation
This is a software written in JavaScript, specifically suited for [Node.js](https://nodejs.org) (<i>JavaScript on the server side</i>). JavaScript is an interpreted programming language thus it is not necessary to compile it nor build any package; having the source code downloaded somewhere in your machine is enough.

###<a name="prerequisites"></a>Prerequisites
This REST API has no sense if an Identity Manager (Keyrock implementation can be found [here](http://catalogue.fiware.org/enablers/identity-management-keyrock)) is not installed.

As said, cosmos-auth is a Node.js application, therefore install it from the official [download](https://nodejs.org/download/). An advanced alternative is to install [Node Version Manager](https://github.com/creationix/nvm) (nvm) by creationix/Tim Caswell, whcih will allow you to have several versions of Node.js and switch among them.

Of course, common tools such as `git` and `curl` may be needed.

[Top](#top)

###<a name="installation"></a>Installation
Start by cloning the Cosmos repository somewhere of your ownership:

    $ git clone https://github.com/telefonicaid/fiware-cosmos.git
    
cosmos-auth code is located at `fiware-cosmos/cosmos-auth`. Change to that directory and execute the installation command:

    $ cd fiware-cosmos/cosmos-auth
    $ npm install
    
That must download all the dependencies under a `node_modules` directory.

[Top](#top)

###<a name="unittests"></a>Unit tests
To be done.

[Top](#top)

##<a name="configuration"></a>Configuration
cosmos-auth is configured through a JSON file. These are the available parameters:

* **host**: FQDN or IP address of the host running the service.
* **port**: TCP listening port for incomming API methods invocation. 13000 by default.
* **private_key_file**: File name containing the private key used to encrypt the communications with the clients.
* **certificate_file**: File name containing the self-signed X509 certificate used by the server to send the clients the public counterpart of the above private key.
* **idm.host**: FQDN or IP address where the Identity Manager runs. Do not write it in URL form!
* **idm.port**: Port where the Identity Manager listens for requests. Typically 443.
* **idm.path**: Path where the Identity Managers serves the tokens generation. Typicaly `/oauth2/token`.
* **cosmos_app.client\_id**: This value is given by the Identity Manager when the Cosmos application is registered. By configuring it here, the user has not the need to know about it.
* **cosmos_app.client\_secret**: This value is given by the Identity Manager when the Cosmos application is registered. By configuring it here, the user has not the need to know about it.

[Top](#top)

##<a name="running"></a>Running
The Http server implemented by cosmos-auth is run as (assuming your current directory is `fiware-cosmos/cosmos-auth`):

    $ npm start
    
If everything goes well, you should be able to remotely ask (using a web browser or `curl` tool) for the version of the software:

    $ curl -X GET "https://<host_running_the_api>:13000/cosmos-auth/v1/version"
    {version: 0.0.0}
    
cosmos-auth typically listens in the TCP/13000 port (TLS encryption), but you can change it by editing `conf/cosmos-auth.json`.

[Top](#top)

##<a name="usage"></a>Usage
Apart from the version method, there is only one available operation in this RESTful API. Use curl this way in order to get an access token:

    curl -X POST "https://<host_running_the_api>:13000/cosmos-auth/v1/token" -H "Content-Type: application/x-www-form-urlencoded" -d "grant_type=password&username=<your_idm_username>&password=<your_idm_password>"
    
Resposne have the following format (JSON encoding):

    {"access_token": "M2ir2989wWhs5mAmj9OJLQdok0MeGl", "token_type": "Bearer", "expires_in": 3600, "refresh_token": "nEy34Tc74HhlA6Hk34uCihUGRppLO9"}
    
[Top](#top)

##<a name="whatis"></a>Contact
francisco dot romerobueno at telefonica dot com **[Main contributor]**
<br>
german dot torodelvalle at telefonica dot com **[Contributor]**

[Top](#top)